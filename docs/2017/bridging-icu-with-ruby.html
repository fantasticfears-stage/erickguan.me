<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.4.1 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>Bridging ICU with Ruby - Blog</title>




<meta name="description" content="Chinese Discourse users have more complains to the text problems. A communitysoftware induce users to read and write which certainly deals with texts.Numerous efforts are made along the way such as tokenizers for Chinese. Maintaininga project is not easy.One of feature request for Discourse is Unicode username. A core technical problemis visually confusing username. Discourse community may be in a multilingualcommunity. This is certainly important to deal with. Although username is thecore identify of the user representation. It’s more than Unicode.">




<meta name="author" content="Erick Guan">

<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Blog">
<meta property="og:title" content="Bridging ICU with Ruby">


  <link rel="canonical" href="https://erickguan.me/2017/bridging-icu-with-ruby">
  <meta property="og:url" content="https://erickguan.me/2017/bridging-icu-with-ruby">



  <meta property="og:description" content="Chinese Discourse users have more complains to the text problems. A communitysoftware induce users to read and write which certainly deals with texts.Numerous efforts are made along the way such as tokenizers for Chinese. Maintaininga project is not easy.One of feature request for Discourse is Unicode username. A core technical problemis visually confusing username. Discourse community may be in a multilingualcommunity. This is certainly important to deal with. Although username is thecore identify of the user representation. It’s more than Unicode.">



  <meta name="twitter:site" content="@erickguan">
  <meta name="twitter:title" content="Bridging ICU with Ruby">
  <meta name="twitter:description" content="Chinese Discourse users have more complains to the text problems. A communitysoftware induce users to read and write which certainly deals with texts.Numerous efforts are made along the way such as tokenizers for Chinese. Maintaininga project is not easy.One of feature request for Discourse is Unicode username. A core technical problemis visually confusing username. Discourse community may be in a multilingualcommunity. This is certainly important to deal with. Although username is thecore identify of the user representation. It’s more than Unicode.">
  <meta name="twitter:url" content="https://erickguan.me/2017/bridging-icu-with-ruby">

  
    <meta name="twitter:card" content="summary">
    
  

  
    <meta name="twitter:creator" content="@Erick Guan">
  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2017-03-14T00:00:00+01:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Erick Guan",
      "url" : "https://erickguan.me",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="https://erickguan.me/feed.xml" type="application/atom+xml" rel="alternate" title="Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="https://erickguan.me/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->

<meta http-equiv="cleartype" content="on">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#da532c">
<meta name="apple-mobile-web-app-title" content="Erick Guan">
<meta name="application-name" content="Erick Guan">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="https://erickguan.me/">Blog</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item"><a href="https://erickguan.me/about">About</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://algalon.net">中文</a></li>
          
        </ul>
        <button><div class="navicon"></div></button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    



<div id="main" role="main">
  

  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Bridging ICU with Ruby">
    <meta itemprop="description" content="Chinese Discourse users have more complains to the text problems. A communitysoftware induce users to read and write which certainly deals with texts.Numerous efforts are made along the way such as tokenizers for Chinese. Maintaininga project is not easy.One of feature request for Discourse is Unicode username. A core technical problemis visually confusing username. Discourse community may be in a multilingualcommunity. This is certainly important to deal with. Although username is thecore identify of the user representation. It’s more than Unicode.">
    <meta itemprop="datePublished" content="March 14, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Bridging ICU with Ruby
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        <p>Chinese Discourse users have more complains to the text problems. A community
software induce users to read and write which certainly deals with texts.
Numerous efforts are made along the way such as tokenizers for Chinese. Maintaining
a project is not easy.
One of feature request for Discourse is Unicode username. A core technical problem
is visually confusing username. Discourse community may be in a multilingual
community. This is certainly important to deal with. Although username is the
core identify of the user representation. It’s more than Unicode.</p>

<h2 id="motivation-and-goals">Motivation and goals</h2>

<p>Somehow, Ruby community doesn’t have much tools for Unicode processing. Unicode
normalization is implemented in the core library in 2.2. And what about <a href="http://unicode.org/reports/tr36/">Unicode
security problems</a>? I don’t want to reinvent the
wheel.
<a href="http://site.icu-project.org/">ICU (International Components for Unicode)</a> is an old and battle-tested
library for the Unicode. A binding with it would worth it. It should have
high performance, easy to maintain and can be deployed with MRI.</p>

<p>There are already some gems.</p>
<ul>
  <li><a href="https://github.com/twitter/twitter-cldr-rb"><code class="highlighter-rouge">twitter-cldr-rb</code> gem</a> is a pure
Ruby implementation based on <a href="http://cldr.unicode.org/">Unicode CLDR</a>. Adding
feature means implementing algorithm on the unicode document.</li>
  <li>Some existing gems are obsolete.</li>
  <li>The binding with ICU is <a href="https://bugs.ruby-lang.org/issues/2034">discussed in MRI tracker</a>.</li>
</ul>

<h2 id="do-it-right">Do it right</h2>

<p>Ruby is really different than other programing languages in terms of its string
implementation. <a href="http://yokolet.blogspot.se/2009/07/design-and-implementation-of-ruby-m17n.html">The <em>Code Set Independent</em> (CSI) model</a>
doesn’t set a common internal encoding but stores the bytes presentation
with encoding information. It allows Ruby convert encodings when it involves I/O operations.
Also, Ruby holds the external encoding <code class="highlighter-rouge">Encoding.default_external</code> which is how Ruby
reads from an IO object. The <code class="highlighter-rouge">IO</code> object is typically a file (<code class="highlighter-rouge">File</code> is a subclass of IO).
The <code class="highlighter-rouge">Encoding.default_internal</code> for new created string is usually UTF-8 from the environment.
<a href="http://nuclearsquid.com/writings/ruby-1-9-encodings/">This starts from Ruby 1.9</a>.</p>

<p>ICU provides <a href="http://userguide.icu-project.org/i18n">many internationalization features</a>. It operates with strings.
So the most operations happen in memory. But ICU <a href="http://userguide.icu-project.org/strings">uses UTF-16 internally</a>. The conversion will happen if
UTF-8 is used as the default encoding.</p>

<p>Also, ICU’s C API uses callback function for error reporting.</p>

<p>A gem with C code can easily access byte arrays. And the conversion in C will be faster
than MRI implementation.</p>

<h2 id="design">Design</h2>

<p>ICU binding should be as transparent as possible. The user only uses the equivalent Ruby
API of ICU. Its module holds a optional internal encoding for the
returning result (usually a string). Since ruby’s string can be any encodings, it have
to be converted to UTF-16 for feeding ICU.</p>

<p>Along the way, <a href="https://silverhammermba.github.io/emberb/examples/"><em>The Definitive Guide to Ruby’s C API</em></a> helps me quite a lot. It’s the most clear reference for Ruby’s C API I’ve seen.</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="https://erickguan.me/tags/#unicode" class="page__taxonomy-item" rel="tag">Unicode</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-03-14T00:00:00+01:00">March 14, 2017</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=erickguan&text=Bridging ICU with Ruby https://erickguan.me/2017/bridging-icu-with-ruby" class="btn btn--twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https://erickguan.me/2017/bridging-icu-with-ruby" class="btn btn--facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=https://erickguan.me/2017/bridging-icu-with-ruby" class="btn btn--google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://erickguan.me/2017/bridging-icu-with-ruby" class="btn btn--linkedin" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="https://erickguan.me/2017/unicode-what-changes" class="pagination--pager" title="Unicode is more than encoding
">Previous</a>
    
    
      <a href="https://erickguan.me/2017/copy-and-paste-bookmarklet" class="pagination--pager" title="Copy and Paste Bookmarklet
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
    
        <h4 class="page__comments-title">Leave a Comment</h4>
        <section id="disqus_thread"></section>
      
</div>
    
  </article>

  
  
</div>


    <div class="page__footer">
      <footer>
        
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="https://twitter.com/erickguan"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="http://github.com/fantasticfears"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="https://erickguan.me/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2017 Erick Guan. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    <script src="https://erickguan.me/assets/js/main.min.js"></script>




  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36993160-8', 'auto');
  ga('send', 'pageview');
</script>





  
      
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'fftenacity';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    



  </body>
</html>
