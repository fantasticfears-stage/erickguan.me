<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.5.1 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>Adding a system call to Linux 3.14 - Blog</title>




<meta name="description" content="There are plenty of blog posts about adding a system call to Linux 2.6, but they are out of date now. Here is a article about adding a system call to Linux 3.14. I assume you can easily add the system call for further kernel. Shane wrote a great post about it.">




<meta name="author" content="Erick Guan">

<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Blog">
<meta property="og:title" content="Adding a system call to Linux 3.14">


  <link rel="canonical" href="https://erickguan.me/2014/add-a-system-call-to-linux-3-14">
  <meta property="og:url" content="https://erickguan.me/2014/add-a-system-call-to-linux-3-14">



  <meta property="og:description" content="There are plenty of blog posts about adding a system call to Linux 2.6, but they are out of date now. Here is a article about adding a system call to Linux 3.14. I assume you can easily add the system call for further kernel. Shane wrote a great post about it.">



  <meta name="twitter:site" content="@erickguan">
  <meta name="twitter:title" content="Adding a system call to Linux 3.14">
  <meta name="twitter:description" content="There are plenty of blog posts about adding a system call to Linux 2.6, but they are out of date now. Here is a article about adding a system call to Linux 3.14. I assume you can easily add the system call for further kernel. Shane wrote a great post about it.">
  <meta name="twitter:url" content="https://erickguan.me/2014/add-a-system-call-to-linux-3-14">

  
    <meta name="twitter:card" content="summary">
    
  

  
    <meta name="twitter:creator" content="@Erick Guan">
  



  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2014-09-10T00:00:00+02:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Erick Guan",
      "url" : "https://erickguan.me",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="https://erickguan.me/feed.xml" type="application/atom+xml" rel="alternate" title="Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="https://erickguan.me/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->

<meta http-equiv="cleartype" content="on">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#da532c">
<meta name="apple-mobile-web-app-title" content="Erick Guan">
<meta name="application-name" content="Erick Guan">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="https://erickguan.me/">Blog</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item"><a href="https://erickguan.me/about">About</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://algalon.net">中文</a></li>
          
        </ul>
        <button><div class="navicon"></div></button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    



<div id="main" role="main">
  

  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Adding a system call to Linux 3.14">
    <meta itemprop="description" content="There are plenty of blog posts about adding a system call to Linux 2.6, but they are out of date now. Here is a article about adding a system call to Linux 3.14. I assume you can easily add the system call for further kernel. Shane wrote a great post about it.">
    <meta itemprop="datePublished" content="September 10, 2014">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Adding a system call to Linux 3.14
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        <p>There are plenty of blog posts about adding a system call to Linux 2.6, but they are out of date now. Here is a article about adding a system call to Linux 3.14. I assume you can easily add the system call for further kernel. Shane wrote a <a href="https://shanetully.com/2014/04/adding-a-syscall-to-linux-3-14/">great post</a> about it.</p>

<h2 id="system-call">System call</h2>

<p><strong>System call</strong> is how a user space application request a service from an operating system. Many libraries, even C standard library, are an wrapper with additional functions.</p>

<h2 id="environment">Environment</h2>

<p>Gentoo Linux(amd64): aufs-sources:3.14.5</p>

<p>If you are not a Gentoo user, you can get the kernel source from your package manager and <a href="http://kernel.org/">The Linux Kernel</a>.</p>

<h2 id="adding-a-system-call">Adding a system call</h2>

<p>A system call is defined in the system call entry table, a system call function prototype and actual implementation for the system call.</p>

<h3 id="syscall-table">syscall table</h3>

<p>The syscall table is located in the <code class="highlighter-rouge">arch/x86/syscalls/syscall_64.tbl</code>.</p>

<h4 id="format">Format</h4>

<p><code class="highlighter-rouge">&lt;numver&gt; &lt;abi&gt; &lt;name&gt; &lt;entry point&gt;</code></p>

<ul>
  <li><code class="highlighter-rouge">number</code>: All syscalls are identified by a unique number. In order to call a syscall, we tell the kernel to call the syscall by its number rather than by its name.</li>
  <li><code class="highlighter-rouge">abi</code>: The ABI, or application binary interface, to use. Either 64, x32, or common for both.</li>
  <li><code class="highlighter-rouge">name</code>: This is simply the name of the syscall.</li>
  <li><code class="highlighter-rouge">entry point</code>: The entry point is the name of the function to call in order to handle the syscall. The naming convention for this function is the name of the syscall prefixed with <code class="highlighter-rouge">sys_</code>. For example, the <code class="highlighter-rouge">read</code> syscall’s entry point is <code class="highlighter-rouge">sys_read</code>.</li>
</ul>

<h4 id="how-to">How-to</h4>

<p>Skipping the table, you’ll find a series of x86 system calls starting with 512. I’ll add the system call in the end after table right above that part.</p>

<p>For 3.14, the last system call is <code class="highlighter-rouge">315 common  sched_getattr       sys_sched_getattr</code>. So I add the new one as 316. It look like this:
<code class="highlighter-rouge">316 common  set_root            sys_set_root</code></p>

<h3 id="system-call-function-prototype">System call function prototype</h3>

<p>We need to define the function prototype in the <code class="highlighter-rouge">include/linux/syscalls.h</code> file.</p>

<p>Simply adding a line: <code class="highlighter-rouge">asmlinkage long sys_set_root(void);</code></p>

<p>We’ll add a system call takes no argument.</p>

<p><code class="highlighter-rouge">asmlinkage</code> is a modifier. This macro tells the compiler that the function should not expect to find any of its arguments in registers (a common optimization), but only on the CPU’s stack. You can find more in <a href="http://kernelnewbies.org/FAQ/asmlinkage">FAQ</a>.</p>

<h3 id="system-call-implementation">System call implementation</h3>

<p>Now, just create a new file <code class="highlighter-rouge">kernel/set_root.c</code>. Kernel style guild requires 8 space tab for indentation. But I will insist 4 space here.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#include &lt;linux/kernel.h&gt;
#include &lt;linux/init.h&gt;
#include &lt;linux/sched.h&gt;
#include &lt;linux/syscalls.h&gt;

asmlinkage long sys_set_root(void)
{
    struct user_namespace *ns = current_user_ns();
    struct cred *new;

    kuid_t kuid = make_kuid(ns, 0);
    kgid_t kgid = make_kgid(ns, 0);

    if (!uid_valid(kuid)) {
        return -EINVAL;
    }

    new = prepare_creds();

    if (new != NULL) {
        new-&gt;uid = kuid;
        new-&gt;gid = kgid;

        new-&gt;euid = kuid;
        new-&gt;egid = kgid;

        new-&gt;suid = kuid;
        new-&gt;sgid = kgid;

        new--&gt;fsuid = kuid;
        new-&gt;fsgid = kgid;

        return commit_creds(new);
    } else {
        abort_creds(new);
        return -ENOMEM;
    }
}
</code></pre>
</div>

<p>The code set the user program as root unconditionally. DO NOT USE THIS KERNEL after the experiment, or you’re in trouble.</p>

<h3 id="adding-our-implementation-to-makefile">Adding our implementation to Makefile</h3>

<p>Adding <code class="highlighter-rouge">set_root.o</code> to the end of <code class="highlighter-rouge">obj-y</code> line in the <code class="highlighter-rouge">kernel/Makefile</code>.</p>

<h3 id="patch-about-the-kernel">Patch about the kernel</h3>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gh">diff --git a/arch/x86/syscalls/syscall_64.tbl b/arch/x86/syscalls/syscall_64.tbl
index a12bddc..413209b 100644
</span><span class="gd">--- a/arch/x86/syscalls/syscall_64.tbl
</span><span class="gi">+++ b/arch/x86/syscalls/syscall_64.tbl
</span><span class="gu">@@ -322,6 +322,7 @@
</span>313    common  finit_module            sys_finit_module
314    common  sched_setattr           sys_sched_setattr
315    common  sched_getattr           sys_sched_getattr
<span class="gi">+316 common  set_root            sys_set_root
</span>
#
# x32-specific system call numbers    start at 512 to avoid cache impact
<span class="gh">diff --git a/include/linux/syscalls.h b/include/linux/syscalls.h
index a747a77..c9f7c3c 100644
</span><span class="gd">--- a/include/linux/syscalls.h
</span><span class="gi">+++ b/include/linux/syscalls.h
</span><span class="gu">@@ -855,4 +855,6 @@ asmlinkage long sys_process_vm_writev(pid_t pid,
</span>asmlinkage long sys_kcmp(pid_t pid1, pid_t pid2, int type,
                        unsigned long idx1, unsigned long idx2);
asmlinkage long sys_finit_module(int fd, const char __user *uargs, int flags);
<span class="gi">+asmlinkage long sys_set_root(void);
+
</span>#endif
<span class="gh">diff --git a/kernel/Makefile b/kernel/Makefile
index bc010ee..def272b 100644
</span><span class="gd">--- a/kernel/Makefile
</span><span class="gi">+++ b/kernel/Makefile
</span><span class="gu">@@ -10,7 +10,7 @@ obj-y     = fork.o exec_domain.o panic.o
</span>            kthread.o sys_ni.o posix-cpu-timers.o
            hrtimer.o nsproxy.o
            notifier.o ksysfs.o cred.o reboot.o
<span class="gd">-           async.o range.o groups.o smpboot.o
</span><span class="gi">+           async.o range.o groups.o smpboot.o set_root.o
</span>
ifdef CONFIG_FUNCTION_TRACER
# Do not trace debug files and internal ftrace files
<span class="gh">diff --git a/kernel/set_root.c b/kernel/set_root.c
</span>new file mode 100644
<span class="gh">index 0000000..97fab9b
</span><span class="gd">--- /dev/null
</span><span class="gi">+++ b/kernel/set_root.c
</span><span class="gu">@@ -0,0 +1,38 @@
</span><span class="gi">+#include &lt;linux/kernel.h&gt;
+#include &lt;linux/init.h&gt;
+#include &lt;linux/sched.h&gt;
+#include &lt;linux/syscalls.h&gt;
+
+asmlinkage long sys_set_root(void)
+{
+    struct user_namespace *ns = current_user_ns();
+    struct cred *new;
+
+    kuid_t kuid = make_kuid(ns, 0);
+    kgid_t kgid = make_kgid(ns, 0);
+
+    if (!uid_valid(kuid)) {
+        return -EINVAL;
+    }
+
+    new = prepare_creds();
+
+    if (new != NULL) {
+        new-&gt;uid = kuid;
+        new-&gt;gid = kgid;
+
+        new-&gt;euid = kuid;
+        new-&gt;egid = kgid;
+
+        new-&gt;suid = kuid;
+        new-&gt;sgid = kgid;
+
+        new-&gt;fsuid = kuid;
+        new-&gt;fsgid = kgid;
+
+        return commit_creds(new);
+    } else {
+        abort_creds(new);
+        return -ENOMEM;
+    }
+}
</span></code></pre>
</div>

<h2 id="testing-by-invoking-system-call-in-a-c-program">Testing by invoking system call in a C program</h2>

<p>You may want to know <a href="http://www.tldp.org/LDP/khg/HyperNews/get/syscall/syscall86.html">how system call works</a>.</p>

<p>But here is only the code according to GNU whoami. The standard library provide the system call wrapper.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;pwd.h&gt;
#include &lt;string.h&gt;
#include &lt;errno.h&gt;

#define SYS_SET_ROOT 316

void whoami(void);

int main()
{
    whoami();

    if (syscall(SYS_SET_ROOT) == -1) {
        fprintf(stderr, "Error calling syscall: %s\n", strerror(errno));
        return 1;
    }

    whoami();

    return 0;
}

void whoami()
{
    // Code modified from GNU whoami source
    // http://git.savannah.gnu.org/gitweb/?p=coreutils.git;a=blob;f=src/whoami.c;h=7301abb146418e36785801ff57a3946068b69fc5;hb=HEAD
    uid_t uid = geteuid();
    struct passwd *pw = getpwuid(uid);

    if (pw != NULL) {
        puts(pw-&gt;pw_name);
    }
}
</code></pre>
</div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="https://erickguan.me/tags/#linux" class="page__taxonomy-item" rel="tag">Linux</a>
    
    </span>
  </p>




        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Updated:</strong> <time datetime="2014-09-10T00:00:00+02:00">September 10, 2014</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=erickguan&text=Adding+a+system+call+to+Linux+3.14%20https%3A%2F%2Ferickguan.me%2F2014%2Fadd-a-system-call-to-linux-3-14" class="btn btn--twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ferickguan.me%2F2014%2Fadd-a-system-call-to-linux-3-14" class="btn btn--facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=https%3A%2F%2Ferickguan.me%2F2014%2Fadd-a-system-call-to-linux-3-14" class="btn btn--google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Ferickguan.me%2F2014%2Fadd-a-system-call-to-linux-3-14" class="btn btn--linkedin" title="Share on LinkedIn"><i class="fa fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="https://erickguan.me/2014/failed-attempt-to-chinese-speech-recognition-service" class="pagination--pager" title="Failed Attempt to Chinese Speech Recognition Service
">Previous</a>
    
    
      <a href="https://erickguan.me/2014/bundle-install-without-vpn-in-china" class="pagination--pager" title="Bundle install without VPN in China
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
    
        <h4 class="page__comments-title">Leave a Comment</h4>
        <section id="disqus_thread"></section>
      
</div>
    
  </article>

  
  
</div>


    <div class="page__footer">
      <footer>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
      <li><a href="https://twitter.com/erickguan"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
    
    
    
      <li><a href="http://github.com/fantasticfears"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="https://erickguan.me/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2017 Erick Guan. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    <script src="https://erickguan.me/assets/js/main.min.js"></script>




  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-36993160-8', 'auto');
  ga('send', 'pageview');
</script>





  
      
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = "https://erickguan.me/2014/add-a-system-call-to-linux-3-14";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/2014/add-a-system-call-to-linux-3-14"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://fftenacity.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    



  </body>
</html>
